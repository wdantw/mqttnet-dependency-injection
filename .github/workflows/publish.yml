name: Publish NuGet Package

on:
  push:
    branches:
      - main  # Триггер на каждый push в main
  pull_request:
    branches:
      - main

env:
  DOTNET_VERSION: '8.x'
  NUGET_SOURCE: 'https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json'
  VERSION: "1.0.0.${{github.run_number}}"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Полный history для GitVersion (если используется)

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore
      
      - name: Pack
        run: dotnet pack --configuration Release --no-build --output ./artifacts /p:Version=${{ env.VERSION }} /p:PackageVersion=${{ env.VERSION }}

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget add source --username ${{ github.repository_owner }} \
            --password ${{ secrets.GITHUB_TOKEN }} \
            --store-password-in-clear-text \
            --name github \
            ${{ env.NUGET_SOURCE }}
          
          dotnet nuget push "./artifacts/*.nupkg" \
            --source "github" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate
            
          dotnet nuget push "./artifacts/*.snupkg" \
            --source github \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate 2>/dev/null || true